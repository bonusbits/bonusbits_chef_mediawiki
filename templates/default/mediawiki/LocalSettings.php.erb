<?php

# Protect against web entry
if ( !defined( 'MEDIAWIKI' ) ) {
        exit;
}


##  Debugging
##########################################
#$wgShowExceptionDetails = true;
#$wgShowSQLErrors = true;
#$wgDebugDumpSql = true;
#$wgShowDBErrorBacktrace = true;
#$wgDebugLogFile = "/var/log/mediawiki/debug.log";


##  Web Settings
##########################################
# $wgDisableOutputCompression = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgDisableOutputCompression'] %>;
$wgSitename = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgSitename'] %>";
$wgMetaNamespace = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgMetaNamespace'] %>";
$wgScriptPath = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgScriptPath'] %>";
$wgArticlePath = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgArticlePath'] %>";
$wgUsePathInfo = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgUsePathInfo'] %>;
$wgScriptExtension = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgScriptExtension'] %>";
$wgFavicon = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgFavicon'] %>";
$wgServer = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgServer'] %>";
$wgStylePath = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgStylePath'] %>";
$wgLogo = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgLogo'] %>";
$wgEnableEmail = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgEnableEmail'] %>;
$wgEnableUserEmail = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgEnableUserEmail'] %>;
$wgEmailAuthentication = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgEmailAuthentication'] %>;
$wgEmergencyContact = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgEmergencyContact'] %>";
$wgPasswordSender = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgPasswordSender'] %>";
$wgEnotifUserTalk = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgEnotifUserTalk'] %>;
$wgEnotifWatchlist = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgEnotifWatchlist'] %>;
$wgExternalLinkTarget = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgExternalLinkTarget'] %>";
$wgUniversalEditButton = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgUniversalEditButton'] %>;


##  Database Settings
##########################################
$wgDBtype = "mysql";
$wgDBserver = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgDBserver'] %>";
$wgDBname = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgDBname'] %>";
$wgDBuser = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgDBuser'] %>";
$wgDBpassword = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgDBpassword'] %>";
$wgDBprefix = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgDBprefix'] %>";
$wgDBTableOptions = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgDBTableOptions'] %>";
$wgDBmysql5 = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgDBmysql5'] %>;


##  Cache and Uploads
##########################################
$wgMainCacheType = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgMainCacheType'] %>;
$wgMemCachedServers = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgMemCachedServers'] %>";
$wgCacheDirectory = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgCacheDirectory'] %>";
$wgEnableUploads = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgEnableUploads'] %>;
$wgUseImageMagick = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgUseImageMagick'] %>;
$wgImageMagickConvertCommand = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgImageMagickConvertCommand'] %>";
$wgUseInstantCommons = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgUseInstantCommons'] %>;
$wgShellLocale = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgShellLocale'] %>";
$wgHashedUploadDirectory = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgHashedUploadDirectory'] %>;
$wgUploadPath = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgUploadPath'] %>";
$wgUploadDirectory = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgUploadDirectory'] %>";


##  Site Settings
##########################################
$wgLanguageCode = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgLanguageCode'] %>";
$wgSecretKey = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgSecretKey'] %>";
$wgUpgradeKey = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgUpgradeKey'] %>";
$wgRightsPage = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgRightsPage'] %>"; # Set to the title of a wiki page that describes your license/copyright
$wgRightsUrl = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgRightsUrl'] %>";
$wgRightsText = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgRightsText'] %>";
$wgRightsIcon = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgRightsIcon'] %>";
$wgDiff3 = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgDiff3'] %>";


##  Permissions
##########################################
$wgGroupPermissions['*']['createaccount'] = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgGroupPermissions']['createaccount'] %>;
$wgGroupPermissions['*']['read'] = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgGroupPermissions']['read'] %>;
$wgGroupPermissions['*']['edit'] = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgGroupPermissions']['edit'] %>;
$wgGroupPermissions['*']['createpage'] = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgGroupPermissions']['createpage'] %>;
$wgGroupPermissions['*']['createtalk'] = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgGroupPermissions']['createtalk'] %>;
$wgGroupPermissions['*']['writeapi'] = <%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgGroupPermissions']['writeapi'] %>;


##  Skin
##########################################
require_once "{$IP}/skins/Vector/Vector.php";
$wgDefaultSkin = "vector";


##  Load Extensions
##########################################
<% node['bonusbits_mediawiki_nginx']['mediawiki']['extensions']['list'].each do |extension| %>
require_once "{$IP}/extensions/<%= extension %>/<%= extension %>.php";
<% end %>


##  ConfirmEdit - ReCaptcha
##########################################
#wfLoadExtensions( array( 'ConfirmEdit', 'ConfirmEdit/ReCaptchaNoCaptcha' ) );
require_once "{$IP}/extensions/ConfirmEdit/ReCaptchaNoCaptcha.php";
$wgCaptchaClass = 'ReCaptchaNoCaptcha';
$wgReCaptchaSiteKey = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgReCaptchaSiteKey'] %>";
$wgReCaptchaSecretKey = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgReCaptchaSecretKey'] %>";
$wgGroupPermissions['*'            ]['skipcaptcha'] = false;
$wgGroupPermissions['user'         ]['skipcaptcha'] = false;
$wgGroupPermissions['autoconfirmed']['skipcaptcha'] = true;
$wgGroupPermissions['bot'          ]['skipcaptcha'] = true; // registered bots
$wgGroupPermissions['sysop'        ]['skipcaptcha'] = true;

$wgCaptchaTriggers['edit']          = true;
$wgCaptchaTriggers['create']        = true;
$wgCaptchaTriggers['createaccount'] = true;
$wgCaptchaTriggers['badlogin'] = true;
$wgCaptchaTriggers['contactpage'] = true; // Adds reCAPTCHA to the contact page if created


##  LOAD BALANCER SETTINGS
##########################################
$wgUsedPrivateIPs = true;


##  Memory Settings
##########################################
$wgMaxShellMemory = 102400*64;
$wgMaxShellTime = 500;
$wgMaxShellFileSize = 102400*64;


##  MobileFrontend
##########################################
$wgMFAutodetectMobileView = true;
$wgMobileFrontendLogo = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgMobileFrontendLogo'] %>";


##  WikiEditor
##########################################
$wgDefaultUserOptions['usebetatoolbar'] = 1;
$wgDefaultUserOptions['usebetatoolbar-cgd'] = 1;
$wgDefaultUserOptions['wikieditor-preview'] = 1;


##  Custom Namespaces
##########################################
define( "NS_HOWTO", 500);
define( "NS_HOWTO_TALK", 501);
define( "NS_REFERENCE", 502);
define( "NS_REFERENCE_TALK", 503);
define( "NS_KB", 506);
define( "NS_KB_TALK", 507);
define( "NS_LIST", 512);
define( "NS_LIST_TALK", 513);

//define( "NS_HOWTO", 3000);
//define( "NS_HOWTO_TALK", 3001);
//define( "NS_REFERENCE", 3002);
//define( "NS_REFERENCE_TALK", 3003);
//define( "NS_KB", 3004);
//define( "NS_KB_TALK", 3005);
//define( "NS_LIST", 3006);
//define( "NS_LIST_TALK", 3007);

// Create Custom NameSpaces
$wgExtraNamespaces[NS_HOWTO] = "HowTo";
$wgExtraNamespaces[NS_HOWTO_TALK] = "HowTo_talk";
$wgExtraNamespaces[NS_REFERENCE] = "Reference";
$wgExtraNamespaces[NS_REFERENCE_TALK] = "Reference_talk";
$wgExtraNamespaces[NS_KB] = "KB";
$wgExtraNamespaces[NS_KB_TALK] = "KB_talk";
$wgExtraNamespaces[NS_LIST] = "List";
$wgExtraNamespaces[NS_LIST_TALK] = "List_talk";

$wgExportFromNamespaces = true;
$wgContentNamespaces = array (
        NS_HOWTO,
        NS_KB,
        NS_MAIN,
        NS_REFERENCE
);


##  Namespace Searched
##########################################
$wgNamespacesToBeSearchedDefault = array(
        NS_CATEGORY             => false,
        NS_CATEGORY_TALK        => false,
        NS_HELP                 => false,
        NS_HELP_TALK            => false,
        NS_HOWTO                => true,
        NS_HOWTO_TALK           => false,
        NS_IMAGE                => false,
        NS_IMAGE_TALK           => false,
        NS_KB                   => true,
        NS_KB_TALK              => false,
        NS_LIST                 => false,
        NS_LIST_TALK            => false,
        NS_MAIN                 => true,
        NS_MEDIAWIKI            => false,
        NS_MEDIAWIKI_TALK       => false,
        NS_PROJECT              => false,
        NS_PROJECT_TALK         => false,
        NS_REFERENCE            => true,
        NS_REFERENCE_TALK       => false,
        NS_TALK                 => false,
        NS_TEMPLATE             => false,
        NS_TEMPLATE_TALK        => false,
        NS_USER                 => false,
        NS_USER_TALK            => false
);


##  HideNamespace
##########################################
require_once( "{$IP}/extensions/HideNamespace/HideNamespace.php" );
$wgHidensNamespaces = array(
        NS_CATEGORY,
        NS_HOWTO,
        NS_KB,
        NS_LIST,
        NS_REFERENCE,
        NS_TEMPLATE
);


##  UploadWizard
##########################################
$wgUploadNavigationUrl = '/wiki/Special:UploadWizard';
$wgFileExtensions = array(
        'bmp',
        'doc',
        'docx',
        'gif',
        'jpeg',
        'jpg',
        'mp3',
        'mp4',
        'mpp',
        'odg',
        'odp',
        'ods',
        'odt',
        'ogg',
        'ogv',
        'pdf',
        'png',
        'ppt',
        'pptx',
        'ps',
        'svg',
        'tiff',
        'webm',
        'wmv',
        'xls',
        'xlsx',
        'zip'
);


##  News
##########################################
#$wgRCMaxAge = 13 * 7 * 24 * 3600; //13 weeks default after 1.16.0
#$wgRCMaxAge = 365 * 24 * 3600; //365 days (I had this since setup News Extension)
$wgRCMaxAge = 260 * 7 * 24 * 3600; //5 years (Trying this out, need to watch DB growth or clutter)


##  MultiBoilerplate
##########################################
$wgMultiBoilerplateOptions = false;
$wgMultiBoilerplateDisplaySpecialPage = true;


##  SVG
##########################################
$wgAllowtitlesInSVG = true;
$wgSVGConverter = 'ImageMagick';
$wgSVGConverters['ImageMagick'] = '"' . $wgImageMagickConvertCommand . '" -background white -thumbnail $widthx$height^! $input PNG:$output';


##  AntiSpoof
###########################################
$wgSharedTables[] = "spoofuser";


##  SpamBlackList
###########################################
ini_set( 'pcre.backtrack_limit', '8M' );

$wgSpamBlacklistFiles = array(
   "http://meta.wikimedia.org/w/index.php?title=Spam_blacklist&action=raw&sb_ver=1",
   "http://en.wikipedia.org/w/index.php?title=MediaWiki:Spam-blacklist&action=raw&sb_ver=1"
);


##  Google Analytics Integration
##########################################
$wgGoogleAnalyticsAccount = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgGoogleAnalyticsAccount'] %>";
# $wgGoogleAnalyticsOtherCode = '<script type="text/javascript" src="https://analytics.example.com/tracking.js"></script>';
# $wgGoogleAnalyticsAnonymizeIP = false;
# $wgGoogleAnalyticsIgnoreNsIDs = array(500);
# $wgGoogleAnalyticsIgnorePages = array('ArticleX', 'Foo:Bar');
$wgGoogleAnalyticsIgnoreSpecials = array( 'Userlogin', 'Userlogout', 'Preferences', 'ChangePassword', 'OATH');
$wgGroupPermissions['sysop']['noanalytics'] = true;
$wgGroupPermissions['bot']['noanalytics'] = true;
$wgGroupPermissions['user']['noanalytics'] = true;


## AutoSitemap
##########################################
wfLoadExtension( 'AutoSitemap' );
$wgAutoSitemap["filename"] = "sitemap.xml";
$wgAutoSitemap["server"] = "<%= node['bonusbits_mediawiki_nginx']['mediawiki']['localsettings']['wgServer'] %>";

$wgAutoSitemap["exclude_namespaces"] = [
    NS_CATEGORY,
    NS_CATEGORY_TALK,
    NS_FILE,
    NS_FILE_TALK,
    NS_HELP,
    NS_HELP_TALK,
    NS_IMAGE,
    NS_IMAGE_TALK,
    NS_LIST,
    NS_LIST_TALK,
    NS_MEDIAWIKI,
    NS_MEDIAWIKI_TALK,
    NS_PROJECT,
    NS_PROJECT_TALK,
    NS_TALK,
    NS_TEMPLATE,
    NS_TEMPLATE_TALK,
    NS_USER,
    NS_USER_TALK
];

$wgAutoSitemap["exclude_pages"] = ['page title to exclude', 'other one'];
$wgAutoSitemap["freq"] = "daily";

## Scribunto
##########################################
$wgScribuntoDefaultEngine = 'luastandalone';
$wgScribuntoUseGeSHi = true;
